#!/bin/bash
var_date=$(date +'%Y%m%d%H%M')
work_path=${work_path:-/home/users/yhao24/b/p9/pytorch/torch_compile_debug}
log_path=${log_path:-/home/users/yhao24/b/p9/logs}
output=${log_path}/merge_trace_${var_date}.log
target_path=${target_path:-${log_path}/merge_trace_${var_date}}
mkdir -p $target_path

echo "work_path: $work_path" >>$output
echo "log_path: $log_path" >>$output
echo "target_path: $target_path" >>$output

echo $output
echo $target_path
# train
# for folder in run_2023_06_05_11_59_06_286292-pid_1079462 run_2023_06_05_12_00_29_971534-pid_1224129 run_2023_06_05_12_01_52_683750-pid_1369234 run_2023_06_05_12_03_21_078125-pid_1514645 run_2023_06_05_12_05_02_051368-pid_1693766 run_2023_06_05_12_07_45_739325-pid_2007705 run_2023_06_05_12_09_18_167787-pid_2188851 run_2023_06_05_12_11_36_724055-pid_2458747 run_2023_06_05_12_12_46_476563-pid_2593148 run_2023_06_05_12_14_41_490466-pid_2827258 run_2023_06_05_12_16_06_372876-pid_2967665 run_2023_06_05_12_17_45_824245-pid_3133527 run_2023_06_05_12_19_35_452178-pid_3287938 run_2023_06_05_12_22_22_552326-pid_3523550 run_2023_06_05_12_24_54_595588-pid_3790810 run_2023_06_05_12_25_56_409044-pid_3880187 run_2023_06_05_12_26_59_962527-pid_3968597 run_2023_06_05_12_28_03_470040-pid_4059110 run_2023_06_05_12_29_28_844065-pid_4168533 run_2023_06_05_12_30_55_812042-pid_123302 run_2023_06_05_12_32_39_729372-pid_286451 run_2023_06_05_12_34_06_765758-pid_431649 run_2023_06_05_12_35_42_164896-pid_548574 run_2023_06_05_12_38_13_033205-pid_754111 run_2023_06_05_12_39_38_481646-pid_872375 run_2023_06_05_12_42_13_736447-pid_1136372 run_2023_06_05_12_44_15_171492-pid_1374658 run_2023_06_05_12_46_28_377733-pid_1625251 run_2023_06_05_12_48_43_536621-pid_1856554 run_2023_06_05_12_52_25_603781-pid_2285608 run_2023_06_05_12_55_55_655870-pid_2681891 run_2023_06_05_12_57_14_196525-pid_2828585 run_2023_06_05_12_58_14_881605-pid_2906738 run_2023_06_05_12_59_52_901216-pid_3098035 run_2023_06_05_13_01_19_512508-pid_3253642 run_2023_06_05_13_03_28_564218-pid_3509072 run_2023_06_05_13_04_51_269069-pid_3674423 run_2023_06_05_13_06_12_452277-pid_3831504 run_2023_06_05_13_07_07_261298-pid_3899165 run_2023_06_05_13_08_41_334387-pid_4005035 run_2023_06_05_13_10_21_618248-pid_4104663 run_2023_06_05_13_11_54_211397-pid_4186389 run_2023_06_05_13_14_01_705534-pid_119235 run_2023_06_05_13_17_00_760766-pid_289923 run_2023_06_05_13_18_56_887107-pid_423735 run_2023_06_05_13_20_17_317919-pid_499052 run_2023_06_05_13_21_57_282786-pid_600663 run_2023_06_05_13_22_42_975835-pid_647459 run_2023_06_05_13_23_48_386084-pid_721482 run_2023_06_05_13_24_28_536329-pid_751741 run_2023_06_05_13_25_48_524211-pid_837490 run_2023_06_05_13_26_35_817142-pid_881656 run_2023_06_05_13_27_21_166950-pid_930102 run_2023_06_05_13_27_55_226320-pid_962058 run_2023_06_05_13_28_47_987094-pid_1013080 run_2023_06_05_13_29_21_579056-pid_1041289 run_2023_06_05_13_30_06_665648-pid_1084867 run_2023_06_05_13_32_57_642215-pid_1244324 run_2023_06_05_13_34_10_729017-pid_1321739 run_2023_06_05_13_34_46_074229-pid_1362491 run_2023_06_05_13_36_11_580297-pid_1455435 run_2023_06_05_13_36_54_521115-pid_1495831 run_2023_06_05_13_37_30_635896-pid_1528420 run_2023_06_05_13_38_42_008971-pid_1599133 run_2023_06_05_13_40_12_288501-pid_1691540 run_2023_06_05_13_41_36_808557-pid_1768699 run_2023_06_05_13_43_45_072151-pid_1907228 run_2023_06_05_13_47_28_124494-pid_2159539 run_2023_06_05_13_48_23_781153-pid_2218554 run_2023_06_05_13_49_53_725994-pid_2305965 run_2023_06_05_13_52_56_483781-pid_2518698 run_2023_06_05_13_54_13_936546-pid_2615306 run_2023_06_05_13_55_39_573796-pid_2700085 run_2023_06_05_13_58_04_407385-pid_2843075 run_2023_06_05_14_02_30_920980-pid_3154944 run_2023_06_05_14_03_13_545853-pid_3194621 run_2023_06_05_14_03_48_279312-pid_3225616 run_2023_06_05_14_04_50_597368-pid_3291171 run_2023_06_05_14_06_12_014815-pid_3377782 run_2023_06_05_14_07_29_119162-pid_3460285 run_2023_06_05_14_10_08_113700-pid_3674799 run_2023_06_05_14_10_55_150360-pid_3732161 run_2023_06_05_14_11_58_002704-pid_3817906 run_2023_06_05_14_12_39_208775-pid_3867658 run_2023_06_05_14_13_23_146468-pid_3917048 run_2023_06_05_14_14_03_252451-pid_3964373 run_2023_06_05_14_14_36_149146-pid_4000319 run_2023_06_05_14_15_25_703241-pid_4054791 run_2023_06_05_14_17_25_002380-pid_13224 run_2023_06_05_14_18_09_633034-pid_73321 run_2023_06_05_14_19_27_347392-pid_172867 run_2023_06_05_14_20_38_039480-pid_259636 run_2023_06_05_14_21_49_388871-pid_336944 run_2023_06_05_14_22_25_512961-pid_387589 run_2023_06_05_14_23_59_167180-pid_508231 run_2023_06_05_14_24_51_122582-pid_556516 run_2023_06_05_14_28_44_467024-pid_810459 run_2023_06_05_14_30_09_139716-pid_902433 run_2023_06_05_14_31_44_394930-pid_990318 run_2023_06_05_14_33_22_487037-pid_1100103 run_2023_06_05_14_34_14_028347-pid_1157095 run_2023_06_05_14_35_49_943793-pid_1266178 run_2023_06_05_14_37_11_394866-pid_1351474 run_2023_06_05_14_37_45_738409-pid_1379116 run_2023_06_05_14_38_51_213810-pid_1443419 run_2023_06_05_14_48_35_312280-pid_2041788 run_2023_06_05_14_50_24_945569-pid_2171614 run_2023_06_05_14_51_41_426881-pid_2252265 run_2023_06_05_14_53_09_686055-pid_2314273 run_2023_06_05_14_55_54_097970-pid_2320014 run_2023_06_05_14_57_16_017192-pid_2329071 run_2023_06_05_14_58_38_956772-pid_2382167 run_2023_06_05_15_00_01_835967-pid_2412224 run_2023_06_05_15_01_36_886139-pid_2461845 run_2023_06_05_15_03_09_219211-pid_2521915 run_2023_06_05_15_04_50_405114-pid_2615430 run_2023_06_05_15_06_00_505869-pid_2700183 run_2023_06_05_15_07_46_867642-pid_2801558 run_2023_06_05_15_09_21_089066-pid_2955994 run_2023_06_05_15_11_45_567660-pid_3197687 run_2023_06_05_15_13_04_404120-pid_3302098 run_2023_06_05_15_14_27_832360-pid_3400461 run_2023_06_05_15_15_29_967132-pid_3449724 run_2023_06_05_15_17_03_051266-pid_3533942 run_2023_06_05_15_19_15_981695-pid_3660173 run_2023_06_05_15_20_41_447332-pid_3718376 run_2023_06_05_15_22_29_539185-pid_3765807 run_2023_06_05_15_24_28_312545-pid_3832191 run_2023_06_05_15_25_56_445835-pid_3897472 run_2023_06_05_15_27_32_052949-pid_3948056 run_2023_06_05_15_31_29_785710-pid_4110209 run_2023_06_05_15_33_24_490805-pid_8596 run_2023_06_05_15_35_14_959087-pid_117181 run_2023_06_05_15_36_14_296590-pid_155161 run_2023_06_05_15_37_46_966680-pid_180169 run_2023_06_05_15_38_46_720349-pid_205297 run_2023_06_05_15_40_43_342701-pid_270171 run_2023_06_05_15_41_58_668777-pid_350518 run_2023_06_05_15_43_17_548989-pid_399444 run_2023_06_05_15_44_45_844613-pid_468032 run_2023_06_05_15_46_46_183775-pid_554100 run_2023_06_05_15_48_11_602614-pid_625661 run_2023_06_05_15_49_32_822344-pid_658956 run_2023_06_05_15_52_55_383526-pid_741504 run_2023_06_05_15_55_07_245366-pid_771435 run_2023_06_05_15_56_35_612897-pid_794041 run_2023_06_05_15_58_07_807113-pid_820068 run_2023_06_05_16_00_45_086335-pid_870191 run_2023_06_05_16_03_18_655375-pid_904127 run_2023_06_05_16_05_01_727996-pid_930421 run_2023_06_05_16_06_02_275113-pid_966275 run_2023_06_05_16_08_45_224540-pid_1110459 run_2023_06_05_16_10_37_041036-pid_1196592 run_2023_06_05_16_12_07_048967-pid_1241672 run_2023_06_05_16_13_40_318028-pid_1291541 run_2023_06_05_16_16_07_648969-pid_1374832 run_2023_06_05_16_17_44_898509-pid_1420561 run_2023_06_05_16_19_16_548633-pid_1438990 run_2023_06_05_16_21_20_170671-pid_1490408 run_2023_06_05_16_22_56_380362-pid_1533185 run_2023_06_05_16_24_52_651000-pid_1578398 run_2023_06_05_16_27_13_352825-pid_1619440 run_2023_06_05_16_28_25_222812-pid_1623669 run_2023_06_05_16_29_37_276122-pid_1631826 run_2023_06_05_16_31_25_009991-pid_1634652 ;
# eval
for folder in run_2023_06_05_16_45_04_632621-pid_1651351 run_2023_06_05_16_46_03_455994-pid_1652721 run_2023_06_05_16_47_03_228983-pid_1654095 run_2023_06_05_16_48_58_559801-pid_1657152 run_2023_06_05_16_49_50_718777-pid_1659906 run_2023_06_05_16_51_07_719290-pid_1661499 run_2023_06_05_16_52_00_053117-pid_1663498 run_2023_06_05_16_53_20_813699-pid_1664078 run_2023_06_05_16_54_25_623658-pid_1667768 run_2023_06_05_16_55_07_440087-pid_1669723 run_2023_06_05_16_56_06_861656-pid_1672285 run_2023_06_05_16_56_59_185312-pid_1675342 run_2023_06_05_16_57_59_068470-pid_1677989 run_2023_06_05_16_59_09_659896-pid_1679440 run_2023_06_05_17_00_38_758102-pid_1681145 run_2023_06_05_17_01_59_701454-pid_1683468 run_2023_06_05_17_02_40_327727-pid_1684040 run_2023_06_05_17_03_23_976200-pid_1685335 run_2023_06_05_17_04_06_549836-pid_1687749 run_2023_06_05_17_04_58_374086-pid_1688666 run_2023_06_05_17_05_52_234665-pid_1702281 run_2023_06_05_17_06_47_729462-pid_1711731 run_2023_06_05_17_07_29_508525-pid_1724021 run_2023_06_05_17_08_20_734332-pid_1730031 run_2023_06_05_17_09_20_327999-pid_1749299 run_2023_06_05_17_10_34_344692-pid_1776358 run_2023_06_05_17_11_27_942034-pid_1794833 run_2023_06_05_17_12_47_156786-pid_1849927 run_2023_06_05_17_14_06_261394-pid_1925083 run_2023_06_05_17_15_22_271876-pid_1982713 run_2023_06_05_17_16_35_808920-pid_2067836 run_2023_06_05_17_18_40_361527-pid_2157327 run_2023_06_05_17_20_52_002170-pid_2252044 run_2023_06_05_17_21_46_407588-pid_2293421 run_2023_06_05_17_22_30_700273-pid_2312871 run_2023_06_05_17_23_34_044121-pid_2354240 run_2023_06_05_17_24_32_799578-pid_2376258 run_2023_06_05_17_25_49_637935-pid_2385563 run_2023_06_05_17_26_42_404667-pid_2397104 run_2023_06_05_17_27_33_358646-pid_2421868 run_2023_06_05_17_28_11_695852-pid_2432548 run_2023_06_05_17_29_14_573327-pid_2481335 run_2023_06_05_17_30_26_353914-pid_2499474 run_2023_06_05_17_31_30_116928-pid_2520832 run_2023_06_05_17_32_42_119432-pid_2527829 run_2023_06_05_17_34_33_587402-pid_2537356 run_2023_06_05_17_35_47_460193-pid_2562682 run_2023_06_05_17_36_38_474904-pid_2592277 run_2023_06_05_17_37_32_738993-pid_2665336 run_2023_06_05_17_43_08_837904-pid_2850963 run_2023_06_05_17_43_42_028323-pid_2876520 run_2023_06_05_17_44_30_753187-pid_2937637 run_2023_06_05_17_45_03_045345-pid_2969412 run_2023_06_05_17_45_49_544085-pid_3018792 run_2023_06_05_17_46_19_399055-pid_3029585 run_2023_06_05_17_46_55_792556-pid_3050029 run_2023_06_05_17_47_23_676366-pid_3059204 run_2023_06_05_17_47_58_054317-pid_3062951 run_2023_06_05_18_17_50_375850-pid_3777461 run_2023_06_05_18_18_20_083915-pid_3778194 run_2023_06_05_18_19_00_132321-pid_3786125 run_2023_06_05_18_20_00_278439-pid_3803757 run_2023_06_05_18_22_09_733250-pid_3844928 run_2023_06_05_18_24_16_200409-pid_3903947 run_2023_06_05_18_27_03_981860-pid_3955077 run_2023_06_05_18_28_51_323645-pid_3984684 run_2023_06_05_18_30_41_769328-pid_3992293 run_2023_06_05_18_33_00_612606-pid_4005884 run_2023_06_05_18_35_38_466067-pid_4072773 run_2023_06_05_18_37_55_164942-pid_4099331 run_2023_06_05_18_41_02_388973-pid_4109743 run_2023_06_05_18_43_00_166181-pid_4114619 run_2023_06_05_18_45_33_984928-pid_4119668 run_2023_06_05_18_46_07_394669-pid_4121112 run_2023_06_05_18_47_02_795277-pid_4122446 run_2023_06_05_18_47_41_188127-pid_4124001 run_2023_06_05_18_48_10_453746-pid_4126972 run_2023_06_05_18_49_01_767000-pid_4130542 run_2023_06_05_18_49_31_893546-pid_4133736 run_2023_06_05_18_50_04_863017-pid_4135571 run_2023_06_05_18_50_54_362312-pid_4138356 run_2023_06_05_18_52_00_946036-pid_4141503 run_2023_06_05_18_52_56_309513-pid_4142792 run_2023_06_05_18_54_11_320124-pid_4144200 run_2023_06_05_18_56_39_850777-pid_4147240 run_2023_06_05_18_57_19_565642-pid_4148794 run_2023_06_05_18_58_28_516274-pid_4150251 run_2023_06_05_19_00_18_590069-pid_4152763 run_2023_06_05_19_02_13_709586-pid_4154609 run_2023_06_05_19_03_31_331641-pid_4156453 run_2023_06_05_19_05_00_990769-pid_4158434 run_2023_06_05_19_07_15_214912-pid_4160983 run_2023_06_05_19_22_58_442655-pid_4176901 run_2023_06_05_19_25_45_697437-pid_4180468 run_2023_06_05_19_26_08_868278-pid_4180822 run_2023_06_05_19_26_49_440333-pid_4182055 run_2023_06_05_19_27_47_591580-pid_4183551 run_2023_06_05_19_28_15_296490-pid_4183931 run_2023_06_05_19_28_50_379013-pid_4185270 run_2023_06_05_19_29_41_386463-pid_4186733 run_2023_06_05_19_30_21_324515-pid_4187467 run_2023_06_05_19_33_00_271922-pid_4191058 run_2023_06_05_19_41_19_030660-pid_7058 run_2023_06_05_19_41_48_598872-pid_8443 run_2023_06_05_19_42_50_185745-pid_9955 run_2023_06_05_19_43_26_823996-pid_10464 run_2023_06_05_19_43_55_056733-pid_11622 run_2023_06_05_19_44_25_062157-pid_12023 run_2023_06_05_19_45_10_625378-pid_13300 run_2023_06_05_19_45_58_518696-pid_13872 run_2023_06_05_19_46_31_155254-pid_15089 run_2023_06_05_19_47_19_236840-pid_16728 run_2023_06_05_19_47_54_240577-pid_17193 run_2023_06_05_19_48_46_004435-pid_18642 run_2023_06_05_19_49_16_735224-pid_19157 run_2023_06_05_19_50_07_900537-pid_20704 run_2023_06_05_19_50_53_440790-pid_22048 run_2023_06_05_19_53_08_461030-pid_26649 run_2023_06_05_19_53_47_011951-pid_28041 run_2023_06_05_19_54_14_918530-pid_28826 run_2023_06_05_19_55_22_823145-pid_30368 run_2023_06_05_19_56_18_497164-pid_32038 run_2023_06_05_19_57_11_350204-pid_33332 run_2023_06_05_19_58_16_067049-pid_34747 run_2023_06_05_19_59_21_971050-pid_36168 run_2023_06_05_20_00_00_770723-pid_36673 run_2023_06_05_20_00_57_128915-pid_38024 run_2023_06_05_20_02_16_136196-pid_39652 run_2023_06_05_20_03_14_487539-pid_41197 run_2023_06_05_20_03_42_819469-pid_42286 run_2023_06_05_20_04_13_673687-pid_42818 run_2023_06_05_20_07_02_641944-pid_48061 run_2023_06_05_20_16_09_623502-pid_57629 run_2023_06_05_20_17_09_529340-pid_59126 run_2023_06_05_20_17_58_228568-pid_60520 run_2023_06_05_20_18_56_361742-pid_61439 run_2023_06_05_20_20_13_863432-pid_63569 run_2023_06_05_20_21_06_043318-pid_64781 run_2023_06_05_20_21_56_506375-pid_65682 run_2023_06_05_20_23_03_061647-pid_67428 run_2023_06_05_20_23_57_838783-pid_68894 run_2023_06_05_20_25_03_762676-pid_70399 run_2023_06_05_20_25_49_043618-pid_71800 run_2023_06_05_20_26_46_371889-pid_73280 run_2023_06_05_20_27_57_820612-pid_74824 run_2023_06_05_20_29_27_886219-pid_76517 run_2023_06_05_20_30_22_118821-pid_78020 run_2023_06_05_20_31_20_062071-pid_79482 run_2023_06_05_20_32_04_808784-pid_80869 run_2023_06_05_20_32_59_104798-pid_81567 run_2023_06_05_20_34_07_580119-pid_83094 run_2023_06_05_20_35_03_995210-pid_84549 run_2023_06_05_20_35_53_489833-pid_85941 run_2023_06_05_20_36_51_415427-pid_87435 run_2023_06_05_20_37_42_964682-pid_88828 run_2023_06_05_20_38_35_876952-pid_89972 run_2023_06_05_20_40_13_921714-pid_93406 run_2023_06_05_20_41_13_386896-pid_94900 run_2023_06_05_20_42_17_498779-pid_96442 run_2023_06_05_20_42_57_703203-pid_97702 run_2023_06_05_20_43_52_784067-pid_98494 run_2023_06_05_20_44_35_596464-pid_99867 run_2023_06_05_20_45_45_632879-pid_101386 run_2023_06_05_20_46_35_097368-pid_102805 run_2023_06_05_20_47_26_014899-pid_104228 run_2023_06_05_20_48_15_896904-pid_104926 run_2023_06_05_20_49_22_050210-pid_106444 run_2023_06_05_20_50_21_938778-pid_107957 run_2023_06_05_20_51_11_596403-pid_109364 run_2023_06_05_20_52_59_629263-pid_111874 run_2023_06_05_20_54_12_660285-pid_113442 run_2023_06_05_20_55_05_678234-pid_116017 run_2023_06_05_20_56_01_548968-pid_117176 run_2023_06_05_20_57_05_671449-pid_119122 run_2023_06_05_20_58_08_016762-pid_120590 run_2023_06_05_20_58_56_960277-pid_122023 run_2023_06_05_20_59_37_524336-pid_123307 run_2023_06_05_21_00_48_354344-pid_124882 run_2023_06_05_21_01_46_654848-pid_126372 run_2023_06_05_21_02_44_680433-pid_127875 run_2023_06_05_21_03_38_649036-pid_128555 run_2023_06_05_21_05_03_436545-pid_130932 run_2023_06_05_21_05_54_271491-pid_132398 run_2023_06_05_21_08_07_136397-pid_135624 run_2023_06_05_21_09_05_369723-pid_136469 run_2023_06_05_21_10_11_449073-pid_137973 run_2023_06_05_21_11_20_881108-pid_139631 run_2023_06_05_21_12_07_631160-pid_140939 run_2023_06_05_21_12_51_932588-pid_142312 run_2023_06_05_21_13_52_933894-pid_143774; do # for folder in run_2023_06_05_11_59_06_286292-pid_1079462
  cd ${work_path}/${folder}
  # check if torchinductor folder exist
  if [ ! -d "torchinductor" ]; then
    echo "${folder} torchinductor folder does not exist." >>$output 2>&1
  else
    cd torchinductor
    if [ -z "$(ls -d *__*/)" ]; then
      echo "${folder} doesn't include models." >>$output 2>&1
    else
      models=$(ls -d *__*/)
      declare -A model_set
      for model in $models; do
        model_name=${model%%__*}
        model_set[$model_name]=1
      done
      # check the size of model_set
      # check if the size of model_set is larger than 1
      if [ ${#model_set[@]} -gt 1 ]; then
        echo "${folder} has more than one model." >>$output 2>&1
      fi
      for model_name in ${!model_set[@]}; do
        echo "model_name: $model_name" >>$output 2>&1
        mkdir ${target_path}/${model_name}
        cp -r ${work_path}/${folder}/torchinductor/${model_name}__* ${target_path}/${model_name}/
      done
      # clean model_set
      unset model_set
    fi
  fi
done
